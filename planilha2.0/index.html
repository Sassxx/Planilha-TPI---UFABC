<!DOCTYPE html>
<html lang="pt-BR" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planejador UFABC - TPI System ‚ú®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        // A cor 'pink' agora √© din√¢mica e controlada pelo usu√°rio
                        pink: {
                            50: 'rgb(var(--color-primary-50) / <alpha-value>)',
                            100: 'rgb(var(--color-primary-100) / <alpha-value>)',
                            200: 'rgb(var(--color-primary-200) / <alpha-value>)',
                            300: 'rgb(var(--color-primary-300) / <alpha-value>)',
                            400: 'rgb(var(--color-primary-400) / <alpha-value>)',
                            500: 'rgb(var(--color-primary-500) / <alpha-value>)',
                            600: 'rgb(var(--color-primary-600) / <alpha-value>)',
                            700: 'rgb(var(--color-primary-700) / <alpha-value>)',
                            800: 'rgb(var(--color-primary-800) / <alpha-value>)',
                            900: 'rgb(var(--color-primary-900) / <alpha-value>)',
                            950: 'rgb(var(--color-primary-950) / <alpha-value>)',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            /* Valores iniciais (Rosa Padr√£o) - Ser√£o sobrescritos pelo JS */
            --color-primary-50: 253 242 248;
            --color-primary-100: 252 231 243;
            --color-primary-200: 251 207 232;
            --color-primary-300: 249 168 212;
            --color-primary-400: 244 114 182;
            --color-primary-500: 236 72 153;
            --color-primary-600: 219 39 119;
            --color-primary-700: 190 24 93;
            --color-primary-800: 157 23 77;
            --color-primary-900: 131 24 67;
            --color-primary-950: 80 7 36;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(var(--color-primary-500), 0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(var(--color-primary-500), 0.5); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(var(--color-primary-500), 0.8); }

        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass {
            background: rgba(var(--color-primary-950), 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body { transition: background-color 0.3s ease, color 0.3s ease; }

        /* Ocultar o input de cor padr√£o feio e usar o √≠cone */
        #color-picker-wrapper {
            position: relative;
            display: inline-block;
        }
        #custom-color-input {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; color: black; }
            .glass { box-shadow: none; border: 1px solid #ddd; background: white; }
            .dark .glass { background: white; color: black; border: 1px solid #ddd; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            main { padding: 0; max-width: 100%; }
            .card { break-inside: avoid; border: 1px solid #ccc; page-break-inside: avoid; }
            h1 { color: black !important; }
        }
    </style>
</head>
<body class="bg-pink-50 text-gray-800 dark:bg-pink-950 dark:text-pink-100 min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 glass shadow-sm transition-colors duration-300 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-graduation-cap text-pink-500 text-2xl"></i>
                    <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-purple-500">
                        UFABC Planner
                    </h1>
                </div>
                <div class="flex gap-2 items-center">
                    
                    <!-- Novo Seletor de Cores RGB/Custom -->
                    <div id="color-picker-wrapper" class="p-2 rounded-full hover:bg-pink-200 dark:hover:bg-pink-900 text-pink-600 dark:text-pink-300 transition-colors" title="Escolher Cor do Tema">
                        <i class="fas fa-palette text-lg"></i>
                        <input type="color" id="custom-color-input" onchange="applyCustomTheme(this.value)" value="#ec4899">
                    </div>

                    <button onclick="toggleAboutModal()" class="p-2 rounded-full hover:bg-pink-200 dark:hover:bg-pink-900 transition-colors focus:outline-none text-pink-600 dark:text-pink-300" title="Sobre o Site">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-pink-200 dark:hover:bg-pink-900 transition-colors focus:outline-none">
                        <i id="theme-icon" class="fas fa-moon text-pink-600 dark:text-pink-300"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modal Sobre -->
    <div id="about-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-black/50 hidden no-print backdrop-blur-sm">
        <div class="bg-white dark:bg-pink-900 rounded-2xl p-8 max-w-lg w-full mx-4 shadow-2xl border border-pink-200 dark:border-pink-700 relative animate-fade-in">
            <button onclick="toggleAboutModal()" class="absolute top-4 right-4 text-gray-400 hover:text-pink-500">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-pink-600 dark:text-pink-300">Sobre o UFABC Planner</h2>
            <div class="space-y-4 text-sm text-gray-600 dark:text-gray-200">
                <p>Planeje sua vida acad√™mica no BC&T e BCH com facilidade.</p>
                <div class="bg-pink-50 dark:bg-pink-950/50 p-3 rounded-lg border border-pink-100 dark:border-pink-800">
                    <h4 class="font-bold text-pink-600 dark:text-pink-300 text-xs uppercase mb-1">Sobre as Mat√©rias:</h4>
                    <p class="text-xs">O banco de dados cont√©m as mat√©rias obrigat√≥rias principais. Como a UFABC tem centenas de mat√©rias, <strong>voc√™ pode adicionar mat√©rias personalizadas</strong> manualmente usando o bot√£o na √°rea de busca!</p>
                </div>
                <p class="italic text-xs mt-4 border-t border-pink-100 pt-4">Seus dados s√£o salvos localmente.</p>
            </div>
        </div>
    </div>

    <!-- Modal Registrar Estudo -->
    <div id="study-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 hidden no-print backdrop-blur-sm transition-opacity">
        <div class="bg-white dark:bg-pink-900 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl border border-pink-200 dark:border-pink-700 relative transform transition-all scale-100">
            <button onclick="closeStudyModal()" class="absolute top-4 right-4 text-gray-400 hover:text-pink-500">
                <i class="fas fa-times text-lg"></i>
            </button>
            <h3 class="text-xl font-bold text-pink-600 dark:text-pink-300 mb-1">Registrar Estudo</h3>
            <p id="modal-course-name" class="text-sm text-gray-500 dark:text-pink-200 mb-4 font-medium">Mat√©ria</p>
            <input type="hidden" id="modal-course-id">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Data</label>
                    <input type="date" id="study-date" class="w-full p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white focus:ring-2 focus:ring-pink-500 outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Tempo (minutos)</label>
                    <div class="flex gap-2">
                        <button onclick="adjustTime(-10)" class="bg-pink-100 text-pink-600 p-2 rounded-lg hover:bg-pink-200 font-bold">-10</button>
                        <input type="number" id="study-minutes" value="60" min="1" class="w-full text-center p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white font-bold text-lg focus:ring-2 focus:ring-pink-500 outline-none">
                        <button onclick="adjustTime(10)" class="bg-pink-100 text-pink-600 p-2 rounded-lg hover:bg-pink-200 font-bold">+10</button>
                    </div>
                </div>
                <button onclick="saveStudySession()" class="w-full bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-3 rounded-xl shadow-lg hover:shadow-xl hover:scale-[1.02] transition-all">Confirmar Registro üöÄ</button>
            </div>
        </div>
    </div>

    <!-- Modal Criar Mat√©ria Personalizada -->
    <div id="custom-course-modal" class="fixed inset-0 z-[70] flex items-center justify-center bg-black/60 hidden no-print backdrop-blur-sm">
        <div class="bg-white dark:bg-pink-900 rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border border-pink-200 dark:border-pink-700 relative animate-fade-in">
            <button onclick="closeCustomCourseModal()" class="absolute top-4 right-4 text-gray-400 hover:text-pink-500">
                <i class="fas fa-times text-lg"></i>
            </button>
            <h3 class="text-xl font-bold text-pink-600 dark:text-pink-300 mb-4">Criar Mat√©ria Personalizada</h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Nome da Disciplina</label>
                    <input type="text" id="custom-name" placeholder="Ex: Engenharia de Rob√¥s" class="w-full p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white focus:ring-2 focus:ring-pink-500 outline-none">
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Teoria (T)</label>
                        <input type="number" id="custom-t" value="4" class="w-full p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white text-center">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Pr√°tica (P)</label>
                        <input type="number" id="custom-p" value="0" class="w-full p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white text-center">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 dark:text-pink-300 uppercase mb-1">Estudo (I)</label>
                        <input type="number" id="custom-i" value="4" class="w-full p-2 rounded-lg border border-pink-200 dark:border-pink-700 dark:bg-pink-800 dark:text-white text-center">
                    </div>
                </div>
                <button onclick="saveCustomCourse()" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-xl shadow-md mt-2">Salvar e Adicionar</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Dashboard -->
        <section class="mb-8">
            <div class="flex justify-between items-center mb-4 no-print">
                <h2 class="text-lg font-bold text-gray-700 dark:text-pink-200">Resumo de Carga Hor√°ria</h2>
                <div class="relative">
                    <select id="dashboard-filter" onchange="calculateDashboard()" class="appearance-none bg-white dark:bg-pink-900 border border-pink-300 dark:border-pink-700 text-pink-700 dark:text-pink-200 py-2 pl-4 pr-10 rounded-xl font-medium focus:outline-none focus:ring-2 focus:ring-pink-500 cursor-pointer shadow-sm text-sm">
                        <option value="doing" selected>üî• Cursando Agora (Atual)</option>
                        <option value="pending">üìÖ Pendentes (Planejado)</option>
                        <option value="completed">‚úÖ Conclu√≠das</option>
                        <option value="all">üìä Tudo (Geral)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-pink-500"><i class="fas fa-chevron-down text-xs"></i></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="glass rounded-2xl p-4 shadow-sm border-l-4 border-pink-400 card transition-all">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-pink-300 mb-1">Cr√©ditos</h3>
                    <p class="text-3xl font-bold text-pink-600 dark:text-pink-200" id="total-credits">0</p>
                    <p class="text-[10px] mt-1 opacity-70">Soma (T + P)</p>
                </div>
                <div class="glass rounded-2xl p-4 shadow-sm border-l-4 border-purple-400 card transition-all">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-pink-300 mb-1">Teoria (T)</h3>
                    <p class="text-3xl font-bold text-purple-600 dark:text-purple-300" id="total-t">0</p>
                    <p class="text-[10px] mt-1 opacity-70">Horas Aula</p>
                </div>
                <div class="glass rounded-2xl p-4 shadow-sm border-l-4 border-blue-400 card transition-all">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-pink-300 mb-1">Pr√°tica (P)</h3>
                    <p class="text-3xl font-bold text-blue-600 dark:text-blue-300" id="total-p">0</p>
                    <p class="text-[10px] mt-1 opacity-70">Horas Lab</p>
                </div>
                <div class="glass rounded-2xl p-4 shadow-sm border-l-4 border-green-400 card transition-all">
                    <h3 class="text-xs font-bold uppercase tracking-wider text-gray-500 dark:text-pink-300 mb-1">Estudo (I)</h3>
                    <p class="text-3xl font-bold text-green-600 dark:text-green-300" id="total-i">0</p>
                    <p class="text-[10px] mt-1 opacity-70">Meta de Estudo</p>
                </div>
            </div>
        </section>

        <!-- Rastreador -->
        <section class="mb-10 card break-inside-avoid">
            <div class="bg-pink-900/90 dark:bg-black/40 rounded-2xl p-6 shadow-md text-pink-50 border border-pink-800 print:bg-white print:text-black print:border-pink-200">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                    <h2 class="text-xl font-bold flex items-center gap-2 text-white print:text-pink-700"><i class="fas fa-stopwatch text-pink-400"></i> 1. Rastreador de Estudo (TPI)</h2>
                    <button onclick="resetWeeklyProgress()" class="no-print text-xs bg-pink-800 hover:bg-pink-700 px-3 py-1 rounded-full text-pink-200 transition-colors mt-2 md:mt-0"><i class="fas fa-undo"></i> Resetar Semana</button>
                </div>
                <div class="border-2 border-dashed border-pink-500/50 rounded-xl p-4 mb-6 bg-black/20 text-center print:bg-gray-50 print:border-gray-300 relative overflow-hidden">
                    <span class="text-lg font-bold text-white print:text-black relative z-10">Progresso Semanal: <span class="text-pink-300 print:text-pink-600" id="tracker-total-done">0.0</span> / <span class="text-white print:text-black" id="tracker-total-goal">0</span> horas</span>
                    <div class="w-full bg-pink-950/50 rounded-full h-2.5 mt-2 print:bg-gray-200 relative z-10">
                        <div id="tracker-progress-bar" class="bg-gradient-to-r from-pink-500 to-purple-500 h-2.5 rounded-full transition-all duration-500 shadow-[0_0_10px_rgba(236,72,153,0.5)]" style="width: 0%"></div>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-pink-700/50 print:border-gray-300">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-pink-950 text-pink-200 text-sm uppercase tracking-wider border-b border-pink-800 print:bg-pink-100 print:text-pink-800">
                                <th class="py-3 px-6 font-semibold">Disciplina</th>
                                <th class="py-3 px-6 font-semibold text-center">Meta TPI (I)</th>
                                <th class="py-3 px-6 font-semibold text-center">Conclu√≠do</th>
                                <th class="py-3 px-6 font-semibold text-right no-print">A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tracker-body" class="bg-pink-900/30 text-sm divide-y divide-pink-800/50 print:bg-white print:text-black print:divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Course Selector -->
        <section class="mb-10 no-print">
            <div class="glass rounded-2xl p-6 shadow-md">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-plus-circle text-pink-500"></i> 2. Adicionar Disciplinas</h2>
                    <button onclick="openCustomCourseModal()" class="text-sm bg-pink-100 text-pink-700 px-3 py-1.5 rounded-lg hover:bg-pink-200 transition-colors mt-2 md:mt-0 font-semibold border border-pink-200">
                        <i class="fas fa-pen"></i> Criar Mat√©ria Personalizada
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <div class="relative flex-grow">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><i class="fas fa-search text-gray-400"></i></span>
                        <input type="text" id="course-search" placeholder="Buscar mat√©ria (ex: Funcoes, raca, genero...)" class="w-full pl-10 pr-4 py-3 rounded-xl border border-pink-200 focus:outline-none focus:ring-2 focus:ring-pink-400 focus:border-transparent dark:bg-pink-900 dark:border-pink-800 dark:text-white transition-all" onkeyup="filterCourses()">
                    </div>
                </div>
                <div id="search-results" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto hidden"></div>
            </div>
        </section>

        <!-- Kanban -->
        <section class="mb-12">
            <h2 class="text-xl font-bold mb-6 flex items-center gap-2"><i class="fas fa-tasks text-pink-500"></i> 3. Seu Fluxo</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="flex flex-col bg-white/50 dark:bg-black/20 rounded-2xl p-4 border border-pink-100 dark:border-pink-900 h-full card">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-pink-200 dark:border-pink-800"><span class="font-bold text-gray-600 dark:text-pink-200">Pendentes</span><span id="count-pending" class="bg-gray-200 dark:bg-pink-800 text-gray-700 dark:text-pink-100 text-xs px-2 py-1 rounded-full">0</span></div>
                    <div id="list-pending" class="flex-grow space-y-3 min-h-[200px]" ondrop="drop(event, 'pending')" ondragover="allowDrop(event)"><div class="text-center text-gray-400 text-sm mt-10 italic empty-msg">Nenhuma mat√©ria planejada</div></div>
                </div>
                <div class="flex flex-col bg-pink-50/80 dark:bg-pink-900/20 rounded-2xl p-4 border border-pink-200 dark:border-pink-800 h-full card">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-pink-200 dark:border-pink-800"><span class="font-bold text-pink-600 dark:text-pink-300">Fazendo (Atual)</span><span id="count-doing" class="bg-pink-200 dark:bg-pink-700 text-pink-700 dark:text-pink-100 text-xs px-2 py-1 rounded-full">0</span></div>
                    <div id="list-doing" class="flex-grow space-y-3 min-h-[200px]" ondrop="drop(event, 'doing')" ondragover="allowDrop(event)"><div class="text-center text-pink-300/50 text-sm mt-10 italic empty-msg">Arraste aqui</div></div>
                </div>
                <div class="flex flex-col bg-white/50 dark:bg-black/20 rounded-2xl p-4 border border-green-100 dark:border-green-900/30 h-full card">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-green-200 dark:border-pink-800"><span class="font-bold text-green-600 dark:text-green-300">Conclu√≠do</span><span id="count-completed" class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-100 text-xs px-2 py-1 rounded-full">0</span></div>
                    <div id="list-completed" class="flex-grow space-y-3 min-h-[200px]" ondrop="drop(event, 'completed')" ondragover="allowDrop(event)"><div class="text-center text-gray-400 text-sm mt-10 italic empty-msg">Nada conclu√≠do ainda</div></div>
                </div>
            </div>
        </section>

        <!-- Lists -->
        <section class="mb-12 card break-inside-avoid">
            <div class="glass rounded-2xl p-6 shadow-md border-t-4 border-pink-500">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-clipboard-list text-pink-500"></i> 4. Listas e Relat√≥rios</h2>
                    <div class="flex gap-2 w-full md:w-auto no-print">
                        <input type="text" id="task-name" placeholder="Tarefa (ex: Lista 1)" class="px-4 py-2 rounded-lg border border-pink-200 dark:bg-pink-900 dark:border-pink-800 focus:outline-none focus:ring-2 focus:ring-pink-400 text-sm w-full" oninput="this.classList.remove('border-red-500', 'ring-2', 'ring-red-500')">
                        <select id="task-subject" class="px-4 py-2 rounded-lg border border-pink-200 dark:bg-pink-900 dark:border-pink-800 focus:outline-none focus:ring-2 focus:ring-pink-400 text-sm max-w-[150px]" onchange="this.classList.remove('border-red-500', 'ring-2', 'ring-red-500', 'animate-pulse')"><option value="">Mat√©ria</option></select>
                        <button onclick="addTask()" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
                <div class="overflow-hidden rounded-xl border border-pink-100 dark:border-pink-800">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="bg-pink-900 text-pink-100 text-sm uppercase tracking-wider"><th class="py-3 px-6 font-semibold">Tarefa</th><th class="py-3 px-6 font-semibold">Mat√©ria</th><th class="py-3 px-6 font-semibold">Status</th><th class="py-3 px-6 font-semibold text-right no-print">Mudar</th></tr></thead>
                        <tbody id="tasks-body" class="bg-white dark:bg-pink-900/30 text-sm divide-y divide-pink-100 dark:divide-pink-800"></tbody>
                    </table>
                    <div id="no-tasks-msg" class="p-8 text-center text-gray-400 dark:text-pink-300/50 italic hidden">Nenhuma tarefa adicionada. Adicione acima!</div>
                </div>
            </div>
        </section>

        <!-- Spreadsheet -->
        <section class="mb-10 card break-inside-avoid">
            <div class="glass rounded-2xl p-6 shadow-md overflow-hidden">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fas fa-table text-pink-500"></i> Planilha Detalhada (T-P-I)</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead><tr class="text-sm text-gray-500 dark:text-pink-300 border-b border-pink-200 dark:border-pink-800"><th class="py-3 px-4">Disciplina</th><th class="py-3 px-4">Categoria</th><th class="py-3 px-4 text-center">T</th><th class="py-3 px-4 text-center">P</th><th class="py-3 px-4 text-center">I</th><th class="py-3 px-4 text-center">Cr√©ditos</th><th class="py-3 px-4 text-right">Status</th><th class="py-3 px-4 text-right no-print">A√ß√£o</th></tr></thead>
                        <tbody id="spreadsheet-body" class="text-sm"></tbody>
                        <tfoot class="border-t-2 border-pink-200 dark:border-pink-700 font-bold bg-pink-50 dark:bg-pink-900/50"><tr><td colspan="2" class="py-3 px-4 text-right">TOTAIS GERAIS:</td><td class="py-3 px-4 text-center text-purple-600 dark:text-purple-300" id="table-total-t">0</td><td class="py-3 px-4 text-center text-blue-600 dark:text-blue-300" id="table-total-p">0</td><td class="py-3 px-4 text-center text-green-600 dark:text-green-300" id="table-total-i">0</td><td class="py-3 px-4 text-center text-pink-600 dark:text-pink-300" id="table-total-credits">0</td><td colspan="2"></td></tr></tfoot>
                    </table>
                </div>
            </div>
        </section>

        <!-- Backup -->
        <section class="mb-12 no-print">
            <div class="glass rounded-2xl p-6 shadow-md border-t-4 border-gray-400 dark:border-gray-600">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-gray-700 dark:text-gray-200"><i class="fas fa-save text-pink-500"></i> Salvar e Restaurar Dados</h2>
                <div class="flex flex-col sm:flex-row gap-4 flex-wrap">
                    <button onclick="downloadData()" class="flex items-center justify-center gap-2 bg-pink-600 hover:bg-pink-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-sm"><i class="fas fa-file-code"></i> Dados (JSON)</button>
                    <button onclick="printPDF()" class="flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-xl font-bold transition-all shadow-sm"><i class="fas fa-file-pdf"></i> Salvar Relat√≥rio PDF</button>
                    <div class="relative"><input type="file" id="upload-input" accept=".json" class="hidden" onchange="uploadData(this)"><button onclick="document.getElementById('upload-input').click()" class="flex items-center justify-center gap-2 bg-white dark:bg-pink-900 border border-pink-300 dark:border-pink-700 text-pink-700 dark:text-pink-100 px-6 py-3 rounded-xl font-bold hover:bg-pink-50 dark:hover:bg-pink-800 transition-all shadow-sm w-full"><i class="fas fa-upload"></i> Carregar Backup</button></div>
                    <button onclick="clearData()" class="flex items-center justify-center gap-2 bg-red-100 hover:bg-red-200 text-red-600 dark:bg-red-900/30 dark:text-red-300 px-6 py-3 rounded-xl font-bold transition-all ml-auto"><i class="fas fa-trash"></i> Limpar Tudo</button>
                </div>
            </div>
        </section>

    </main>

    <footer class="text-center py-6 text-sm text-pink-400 dark:text-pink-600 no-print"><p>Feito para ajudar alunos do BC&T e BCH da UFABC ‚ú®</p></footer>

    <!-- Templates -->
    <template id="card-template">
        <div class="bg-white dark:bg-pink-800 rounded-xl p-3 shadow-sm border border-pink-100 dark:border-pink-700 hover:shadow-md transition-shadow cursor-move group relative card" draggable="true">
            <div class="flex justify-between items-start">
                <h4 class="font-bold text-gray-800 dark:text-pink-50 text-sm leading-tight pr-4 item-name">Nome Mat√©ria</h4>
                <button class="text-gray-300 hover:text-red-400 transition-colors absolute top-2 right-2 delete-btn no-print">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex gap-2 mt-2 text-xs">
                <span class="bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-200 px-1.5 py-0.5 rounded item-t" title="Teoria">T:0</span>
                <span class="bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 px-1.5 py-0.5 rounded item-p" title="Pr√°tica">P:0</span>
                <span class="bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-200 px-1.5 py-0.5 rounded item-i" title="Estudo Individual">I:0</span>
            </div>
            <!-- NEW SECTION: Total Weekly Hours Feedback -->
            <div class="mt-2 pt-2 border-t border-gray-100 dark:border-pink-700/50 flex justify-between items-center text-xs">
                <span class="text-gray-400 dark:text-pink-300/70">Dedica√ß√£o necess√°ria:</span>
                <span class="font-bold text-pink-600 dark:text-pink-300 item-total">0h</span>
            </div>
            <!-- END NEW SECTION -->
            <div class="mt-3 pt-2 border-t border-gray-100 dark:border-pink-700 flex justify-between text-xs md:hidden no-print">
                <button class="move-prev text-gray-400 hover:text-pink-500"><i class="fas fa-arrow-left"></i></button>
                <button class="move-next text-gray-400 hover:text-pink-500"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </template>

    <script>
        // --- Data: UFABC Courses Database ---
        const courseDB = [
            { id: 'bcmt', name: 'Bases Computacionais da Ci√™ncia', t: 0, p: 2, i: 2, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'bm', name: 'Bases Matem√°ticas', t: 4, p: 0, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'be', name: 'Bases Experimentais das Ci√™ncias Naturais', t: 0, p: 3, i: 2, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'em', name: 'Estrutura da Mat√©ria', t: 3, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'fuv', name: 'Fun√ß√µes de Uma Vari√°vel', t: 4, p: 0, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'ga', name: 'Geometria Anal√≠tica', t: 3, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'fenmec', name: 'Fen√¥menos Mec√¢nicos', t: 3, p: 1, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'transcal', name: 'Fen√¥menos T√©rmicos', t: 3, p: 1, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'evolucao', name: 'Evolu√ß√£o e Diversidade', t: 3, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'bio', name: 'Biodiversidade: Intera√ß√µes e Transforma√ß√µes', t: 3, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'pi', name: 'Processamento da Informa√ß√£o', t: 2, p: 2, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'qg', name: 'Transforma√ß√µes Qu√≠micas', t: 3, p: 1, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'fvv', name: 'Fun√ß√µes de V√°rias Vari√°veis', t: 4, p: 0, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'ieds', name: 'Intro. as Equa√ß√µes Diferenciais Ordin√°rias', t: 4, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'mc', name: 'Mec√¢nica Qu√¢ntica', t: 3, p: 0, i: 4, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'iem', name: 'Intera√ß√µes Eletromagn√©ticas', t: 3, p: 1, i: 5, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'ni', name: 'Natureza da Informa√ß√£o', t: 3, p: 0, i: 3, cat: 'BC&T - Obrigat√≥ria' },
            { id: 'becm', name: 'Bases Epistemol√≥gicas da Ci√™ncia Moderna', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'eds', name: 'Estrutura e Din√¢mica Social', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'erp', name: 'Estado e Rela√ß√µes de Poder', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'pe_bch', name: 'Pensamento Econ√¥mico', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'ics', name: 'Identidade, Cultura e Subjetividade', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'ts', name: 'Territ√≥rio e Sociedade', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'formacao', name: 'Forma√ß√£o do Sistema Internacional', t: 3, p: 0, i: 4, cat: 'BCH - Obrigat√≥ria' },
            { id: 'intro_hcs', name: 'Introdu√ß√£o √†s Humanidades e Ci√™ncias Sociais', t: 2, p: 0, i: 2, cat: 'BCH - Obrigat√≥ria' },
            { id: 'cts', name: 'Ci√™ncia, Tecnologia e Sociedade', t: 3, p: 0, i: 3, cat: 'Interdisciplinar' },
            { id: 'ep', name: '√âtica e Justi√ßa', t: 3, p: 0, i: 3, cat: 'Interdisciplinar' },
            { id: 'drgr', name: 'Desigualdade de Ra√ßa, G√™nero e Renda', t: 3, p: 0, i: 4, cat: 'Op√ß√£o Livre' },
            { id: 'fmc', name: 'F√≠sica Matem√°tica e Computacional', t: 4, p: 0, i: 4, cat: 'BC&T - Op√ß√£o' },
            { id: 'pe_est', name: 'Probabilidade e Estat√≠stica', t: 4, p: 0, i: 4, cat: 'BC&T - Op√ß√£o' },
            { id: 'al', name: '√Ålgebra Linear', t: 4, p: 0, i: 4, cat: 'BC&T - Op√ß√£o' }
        ];

        // State Management
        let userCourses = JSON.parse(localStorage.getItem('ufabc_planner_courses')) || [];
        let userTasks = JSON.parse(localStorage.getItem('ufabc_planner_tasks')) || [];
        let savedHexColor = localStorage.getItem('ufabc_planner_custom_color') || '#ec4899'; // Default Pink

        // Ensure legacy courses have 'studied' and logs
        userCourses = userCourses.map(c => ({
            ...c,
            studied: c.studied || 0,
            logs: c.logs || [] 
        }));

        // --- Color Theme Logic (Dynamic RGB) ---
        function hexToRgb(hex) {
            // Remove hash if present
            hex = hex.replace(/^#/, '');
            // Parse
            let bigint = parseInt(hex, 16);
            let r = (bigint >> 16) & 255;
            let g = (bigint >> 8) & 255;
            let b = bigint & 255;
            return [r, g, b];
        }

        // Calculate tint/shade: factor > 0 lightens, factor < 0 darkens
        function adjustColor(r, g, b, factor) {
            let target = factor > 0 ? 255 : 0; // Mix with white or black
            let p = Math.abs(factor);
            
            let newR = Math.round(r + (target - r) * p);
            let newG = Math.round(g + (target - g) * p);
            let newB = Math.round(b + (target - b) * p);
            
            return `${newR} ${newG} ${newB}`;
        }

        function applyCustomTheme(hexColor) {
            savedHexColor = hexColor;
            localStorage.setItem('ufabc_planner_custom_color', hexColor);
            
            const [r, g, b] = hexToRgb(hexColor);
            const root = document.documentElement;

            // Define palette levels based on base color (500)
            // 50-400: Mix with white (0.95 down to 0.1)
            // 500: Base
            // 600-950: Mix with black (0.1 up to 0.8)

            root.style.setProperty('--color-primary-50', adjustColor(r, g, b, 0.95));
            root.style.setProperty('--color-primary-100', adjustColor(r, g, b, 0.9));
            root.style.setProperty('--color-primary-200', adjustColor(r, g, b, 0.75));
            root.style.setProperty('--color-primary-300', adjustColor(r, g, b, 0.5));
            root.style.setProperty('--color-primary-400', adjustColor(r, g, b, 0.25));
            
            root.style.setProperty('--color-primary-500', `${r} ${g} ${b}`);
            
            root.style.setProperty('--color-primary-600', adjustColor(r, g, b, -0.1));
            root.style.setProperty('--color-primary-700', adjustColor(r, g, b, -0.25));
            root.style.setProperty('--color-primary-800', adjustColor(r, g, b, -0.45));
            root.style.setProperty('--color-primary-900', adjustColor(r, g, b, -0.65));
            root.style.setProperty('--color-primary-950', adjustColor(r, g, b, -0.8));
        }

        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-icon');
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                html.classList.add('light');
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            }
        }
        
        function toggleAboutModal() {
            document.getElementById('about-modal').classList.toggle('hidden');
        }

        // --- Custom Course Logic ---
        function openCustomCourseModal() {
            document.getElementById('custom-course-modal').classList.remove('hidden');
        }

        function closeCustomCourseModal() {
            document.getElementById('custom-course-modal').classList.add('hidden');
        }

        function saveCustomCourse() {
            const name = document.getElementById('custom-name').value;
            const t = parseInt(document.getElementById('custom-t').value) || 0;
            const p = parseInt(document.getElementById('custom-p').value) || 0;
            const i = parseInt(document.getElementById('custom-i').value) || 0;

            if(!name) { alert("Digite o nome da mat√©ria!"); return; }

            const newCourse = {
                id: 'custom-' + Date.now(),
                name: name,
                t: t,
                p: p,
                i: i,
                cat: 'Personalizada',
                status: 'pending',
                studied: 0,
                logs: []
            };

            userCourses.push(newCourse);
            saveAndRender();
            closeCustomCourseModal();
            // Clear Inputs
            document.getElementById('custom-name').value = '';
        }

        // --- Core Logic ---
        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function filterCourses() {
            const rawInput = document.getElementById('course-search').value;
            const normalizedInput = normalizeText(rawInput);
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            if (normalizedInput.length < 2) {
                resultsDiv.classList.add('hidden');
                return;
            }

            const filtered = courseDB.filter(c => 
                normalizeText(c.name).includes(normalizedInput) && 
                !userCourses.some(uc => uc.id === c.id) 
            );

            if (filtered.length > 0) {
                resultsDiv.classList.remove('hidden');
                filtered.forEach(c => {
                    const btn = document.createElement('div');
                    btn.className = 'p-3 bg-white dark:bg-pink-800 rounded-xl shadow-sm border border-pink-100 dark:border-pink-700 hover:bg-pink-50 dark:hover:bg-pink-700 cursor-pointer flex justify-between items-center group transition-all';
                    btn.innerHTML = `
                        <div>
                            <div class="font-bold text-sm text-gray-800 dark:text-white">${c.name}</div>
                            <div class="text-xs text-gray-500 dark:text-pink-300">
                                <span class="mr-2">T:${c.t} P:${c.p} I:${c.i}</span>
                                <span class="font-bold text-pink-600 dark:text-pink-400">Total: ${c.t + c.p + c.i}h/sem</span>
                            </div>
                        </div>
                        <i class="fas fa-plus text-pink-400 group-hover:text-pink-600"></i>
                    `;
                    btn.onclick = () => addCourse(c);
                    resultsDiv.appendChild(btn);
                });
            } else {
                resultsDiv.classList.add('hidden');
            }
        }

        function addCourse(course) {
            const newEntry = { ...course, status: 'pending', studied: 0, logs: [] }; 
            userCourses.push(newEntry);
            saveAndRender();
            document.getElementById('course-search').value = '';
            document.getElementById('search-results').classList.add('hidden');
        }

        function removeCourse(id) {
            userCourses = userCourses.filter(c => c.id !== id);
            saveAndRender();
        }

        function moveStatus(id, newStatus) {
            const idx = userCourses.findIndex(c => c.id === id);
            if (idx > -1) {
                userCourses[idx].status = newStatus;
                saveAndRender();
            }
        }

        // --- Dashboard Filter Logic ---
        
        function calculateDashboard() {
            const filter = document.getElementById('dashboard-filter').value;
            let filteredCourses = userCourses;

            if (filter !== 'all') {
                filteredCourses = userCourses.filter(c => c.status === filter);
            }

            let totalT = 0, totalP = 0, totalI = 0;
            filteredCourses.forEach(c => {
                totalT += c.t;
                totalP += c.p;
                totalI += c.i;
            });

            document.getElementById('total-t').innerText = totalT;
            document.getElementById('total-p').innerText = totalP;
            document.getElementById('total-i').innerText = totalI;
            document.getElementById('total-credits').innerText = totalT + totalP;
        }

        // --- Study Tracker & Modal Functions ---

        function openStudyModal(courseId) {
            const course = userCourses.find(c => c.id === courseId);
            if(!course) return;

            document.getElementById('modal-course-name').innerText = course.name;
            document.getElementById('modal-course-id').value = courseId;
            document.getElementById('study-minutes').value = 60;
            
            const now = new Date();
            const localDate = now.toISOString().split('T')[0];
            document.getElementById('study-date').value = localDate;

            const modal = document.getElementById('study-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.firstElementChild.classList.remove('scale-95', 'opacity-0'), 10);
        }

        function closeStudyModal() {
            const modal = document.getElementById('study-modal');
            modal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function adjustTime(amount) {
            const input = document.getElementById('study-minutes');
            let val = parseInt(input.value) || 0;
            val = Math.max(1, val + amount);
            input.value = val;
        }

        function saveStudySession() {
            const id = document.getElementById('modal-course-id').value;
            const date = document.getElementById('study-date').value;
            const minutes = parseInt(document.getElementById('study-minutes').value);

            if (!date || !minutes || minutes <= 0) {
                alert("Por favor, preencha a data e um tempo v√°lido.");
                return;
            }

            const idx = userCourses.findIndex(c => c.id === id);
            if (idx > -1) {
                const oldStudied = userCourses[idx].studied || 0;
                const addedHours = minutes / 60.0;
                
                userCourses[idx].studied = oldStudied + addedHours;
                if (!userCourses[idx].logs) userCourses[idx].logs = [];
                
                userCourses[idx].logs.push({
                    date: date,
                    minutes: minutes,
                    timestamp: new Date().toISOString()
                });

                if (userCourses[idx].studied >= userCourses[idx].i && oldStudied < userCourses[idx].i) {
                    triggerConfetti();
                }

                saveAndRender();
                closeStudyModal();
            }
        }

        function triggerConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };
            var random = function(min, max) { return Math.random() * (max - min) + min; };
            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { return clearInterval(interval); }
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: random(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        function addStudyTime(id, minutes) {
            const idx = userCourses.findIndex(c => c.id === id);
            if (idx > -1) {
                const today = new Date().toISOString().split('T')[0];
                const oldStudied = userCourses[idx].studied || 0;
                
                userCourses[idx].studied = oldStudied + (minutes / 60);
                if (!userCourses[idx].logs) userCourses[idx].logs = [];
                
                userCourses[idx].logs.push({
                    date: today,
                    minutes: minutes,
                    timestamp: new Date().toISOString(),
                    type: 'quick'
                });

                if (userCourses[idx].studied >= userCourses[idx].i && oldStudied < userCourses[idx].i) {
                    triggerConfetti();
                }

                saveAndRender();
            }
        }

        function resetWeeklyProgress() {
            if(confirm("Deseja zerar todo o progresso de estudo desta semana?")) {
                userCourses.forEach(c => {
                    c.studied = 0;
                    // c.logs = []; // Keep history
                });
                saveAndRender();
            }
        }

        // --- Rendering ---

        function renderTracker() {
            const tbody = document.getElementById('tracker-body');
            tbody.innerHTML = '';

            const doingCourses = userCourses.filter(c => c.status === 'doing');
            
            if (doingCourses.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="4" class="py-6 text-center text-pink-300 italic">Nenhuma mat√©ria sendo cursada no momento. Arraste mat√©rias para "Fazendo" no quadro abaixo.</td></tr>`;
                 updateTrackerHeader(0, 0);
                 return;
            }

            let totalGoal = 0;
            let totalDone = 0;

            doingCourses.forEach(c => {
                totalGoal += c.i;
                totalDone += (c.studied || 0);

                const isComplete = (c.studied || 0) >= c.i;
                const rowClass = isComplete ? "bg-green-900/20" : "";
                const textClass = isComplete ? "text-green-300" : "text-white";

                const tr = document.createElement('tr');
                tr.className = `border-b border-pink-800/30 hover:bg-pink-800/20 transition-colors text-white text-black print:text-black print:border-gray-200 ${rowClass}`;
                tr.innerHTML = `
                    <td class="py-4 px-6 font-medium ${textClass}">
                        ${c.name}
                        ${isComplete ? '<i class="fas fa-check-circle ml-2"></i>' : ''}
                    </td>
                    <td class="py-4 px-6 text-center font-bold text-pink-400 print:text-pink-700">${c.i}h</td>
                    <td class="py-4 px-6 text-center font-bold text-pink-400 print:text-pink-700">${(c.studied || 0).toFixed(1)}h</td>
                    <td class="py-4 px-6 text-right no-print">
                        <div class="flex justify-end gap-2 items-center">
                            <button onclick="openStudyModal('${c.id}')" class="bg-white/10 hover:bg-white/20 text-white border border-white/30 px-3 py-1 rounded-lg text-xs transition-all mr-2" title="Registrar com Data">
                                <i class="far fa-calendar-alt"></i> Registrar
                            </button>
                            <div class="h-6 w-px bg-white/20 mx-1"></div>
                            <button onclick="addStudyTime('${c.id}', 30)" class="bg-pink-700 hover:bg-pink-600 text-white text-xs px-3 py-1 rounded-lg transition-all">+ 30m</button>
                            <button onclick="addStudyTime('${c.id}', 60)" class="bg-pink-500 hover:bg-pink-400 text-white text-xs px-3 py-1 rounded-lg transition-all">+ 1h</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateTrackerHeader(totalDone, totalGoal);
        }

        function updateTrackerHeader(done, goal) {
            document.getElementById('tracker-total-done').innerText = done.toFixed(1);
            document.getElementById('tracker-total-goal').innerText = goal + " horas";
            
            let percentage = 0;
            if(goal > 0) {
                percentage = (done / goal) * 100;
                if(percentage > 100) percentage = 100;
            }
            document.getElementById('tracker-progress-bar').style.width = `${percentage}%`;
        }

        function renderKanban() {
            ['pending', 'doing', 'completed'].forEach(s => {
                const el = document.getElementById(`list-${s}`);
                const empty = el.querySelector('.empty-msg');
                el.innerHTML = '';
                if(empty) el.appendChild(empty);
            });

            const counts = { pending: 0, doing: 0, completed: 0 };

            userCourses.forEach(course => {
                counts[course.status]++;
                const listEl = document.getElementById(`list-${course.status}`);
                const empty = listEl.querySelector('.empty-msg');
                if(empty) empty.style.display = 'none';

                const tmpl = document.getElementById('card-template');
                const clone = tmpl.content.cloneNode(true);
                const card = clone.querySelector('div');
                
                card.ondragstart = (ev) => drag(ev, course.id);
                card.querySelector('.item-name').innerText = course.name;
                card.querySelector('.item-t').innerText = `T:${course.t}`;
                card.querySelector('.item-p').innerText = `P:${course.p}`;
                card.querySelector('.item-i').innerText = `I:${course.i}`;
                
                // Feedback de Horas Totais
                const totalLoad = course.t + course.p + course.i;
                card.querySelector('.item-total').innerText = `${totalLoad}h`;

                card.querySelector('.delete-btn').onclick = () => removeCourse(course.id);

                const statuses = ['pending', 'doing', 'completed'];
                const currentIdx = statuses.indexOf(course.status);
                const btnPrev = card.querySelector('.move-prev');
                const btnNext = card.querySelector('.move-next');

                if (currentIdx > 0) btnPrev.onclick = () => moveStatus(course.id, statuses[currentIdx - 1]);
                else btnPrev.style.visibility = 'hidden';

                if (currentIdx < 2) btnNext.onclick = () => moveStatus(course.id, statuses[currentIdx + 1]);
                else btnNext.style.visibility = 'hidden';

                listEl.appendChild(card);
            });

            document.getElementById('count-pending').innerText = counts.pending;
            document.getElementById('count-doing').innerText = counts.doing;
            document.getElementById('count-completed').innerText = counts.completed;

            ['pending', 'doing', 'completed'].forEach(s => {
                if(counts[s] === 0) {
                    const el = document.getElementById(`list-${s}`);
                    const empty = document.createElement('div');
                    empty.className = 'text-center text-gray-400 text-sm mt-10 italic empty-msg';
                    empty.innerText = s === 'pending' ? 'Nada pendente' : s === 'doing' ? 'Arraste aqui' : 'Nada conclu√≠do';
                    el.appendChild(empty);
                }
            });
        }

        function renderSpreadsheet() {
            const tbody = document.getElementById('spreadsheet-body');
            tbody.innerHTML = '';
            
            let totalT = 0, totalP = 0, totalI = 0;

            userCourses.forEach(c => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-pink-100 dark:border-pink-800 hover:bg-pink-50 dark:hover:bg-pink-900/50 transition-colors';
                
                const statusColors = {
                    'pending': 'text-gray-500',
                    'doing': 'text-pink-600 font-bold',
                    'completed': 'text-green-600'
                };
                
                const statusLabels = {
                    'pending': 'Pendente',
                    'doing': 'Cursando',
                    'completed': 'Feito'
                };

                tr.innerHTML = `
                    <td class="py-3 px-4 font-medium text-gray-700 dark:text-pink-100">${c.name}</td>
                    <td class="py-3 px-4 text-xs text-gray-500 dark:text-pink-300">${c.cat}</td>
                    <td class="py-3 px-4 text-center text-gray-600 dark:text-pink-200">${c.t}</td>
                    <td class="py-3 px-4 text-center text-gray-600 dark:text-pink-200">${c.p}</td>
                    <td class="py-3 px-4 text-center text-gray-600 dark:text-pink-200">${c.i}</td>
                    <td class="py-3 px-4 text-center font-bold text-pink-500">${c.t + c.p}</td>
                    <td class="py-3 px-4 text-right ${statusColors[c.status]} text-xs uppercase tracking-wide">${statusLabels[c.status]}</td>
                    <td class="py-3 px-4 text-right no-print">
                        <button onclick="removeCourse('${c.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);

                totalT += c.t;
                totalP += c.p;
                totalI += c.i;
            });

            document.getElementById('table-total-t').innerText = totalT;
            document.getElementById('table-total-p').innerText = totalP;
            document.getElementById('table-total-i').innerText = totalI;
            document.getElementById('table-total-credits').innerText = totalT + totalP;
        }

        function updateTaskSubjectSelect() {
            const select = document.getElementById('task-subject');
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione a Mat√©ria...</option>';
            const groups = { 'doing': document.createElement('optgroup'), 'pending': document.createElement('optgroup'), 'completed': document.createElement('optgroup') };
            groups['doing'].label = "Cursando Agora (Fazendo)"; groups['pending'].label = "Planejadas (Pendentes)"; groups['completed'].label = "Conclu√≠das";
            let hasDoing = false; let hasPending = false; let hasCompleted = false;
            userCourses.forEach(c => {
                const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name;
                if (groups[c.status]) { groups[c.status].appendChild(opt); if(c.status === 'doing') hasDoing = true; if(c.status === 'pending') hasPending = true; if(c.status === 'completed') hasCompleted = true; }
            });
            if(hasDoing) select.appendChild(groups['doing']); if(hasPending) select.appendChild(groups['pending']); if(hasCompleted) select.appendChild(groups['completed']);
            if (currentVal) select.value = currentVal;
        }

        function addTask() {
            const nameInput = document.getElementById('task-name'); const subjectSelect = document.getElementById('task-subject');
            nameInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500'); subjectSelect.classList.remove('border-red-500', 'ring-2', 'ring-red-500', 'animate-pulse');
            const name = nameInput.value.trim(); const subjectId = subjectSelect.value;
            if (userCourses.length === 0) { alert("Voc√™ precisa adicionar disciplinas ao seu plano (na se√ß√£o 1) antes de criar tarefas!"); document.getElementById('course-search').focus(); return; }
            let hasError = false;
            if (!name) { nameInput.classList.add('border-red-500', 'ring-2', 'ring-red-500'); hasError = true; }
            if (!subjectId) { subjectSelect.classList.add('border-red-500', 'ring-2', 'ring-red-500', 'animate-pulse'); hasError = true; setTimeout(() => alert("‚ö†Ô∏è Selecione a mat√©ria na lista!"), 10); }
            if (hasError) return;
            const subject = userCourses.find(c => c.id === subjectId);
            const newTask = { id: Date.now().toString(), name: name, subjectId: subjectId, subjectName: subject ? subject.name : 'Desconhecida', status: 'pending' };
            userTasks.push(newTask); nameInput.value = ''; subjectSelect.value = '';
            nameInput.classList.remove('border-red-500', 'ring-2', 'ring-red-500'); subjectSelect.classList.remove('border-red-500', 'ring-2', 'ring-red-500', 'animate-pulse');
            saveAndRender();
        }

        function toggleTaskStatus(taskId) { const task = userTasks.find(t => t.id === taskId); if (task) { task.status = task.status === 'pending' ? 'completed' : 'pending'; saveAndRender(); } }
        function removeTask(taskId) { userTasks = userTasks.filter(t => t.id !== taskId); saveAndRender(); }
        
        function renderTasks() {
            updateTaskSubjectSelect();
            const tbody = document.getElementById('tasks-body'); const msg = document.getElementById('no-tasks-msg'); tbody.innerHTML = '';
            if (userTasks.length === 0) { msg.classList.remove('hidden'); return; } else { msg.classList.add('hidden'); }
            userTasks.forEach(task => {
                const tr = document.createElement('tr'); tr.className = 'group hover:bg-pink-50 dark:hover:bg-pink-900/40 transition-colors';
                const isDone = task.status === 'completed';
                const statusHtml = isDone ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">CONCLU√çDO</span>` : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-pink-100 text-pink-800 dark:bg-pink-900 dark:text-pink-200">PENDENTE</span>`;
                const btnText = isDone ? 'Reabrir' : 'Concluir'; const btnClass = isDone ? 'bg-gray-200 text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200' : 'bg-pink-500 text-white hover:bg-pink-600';
                tr.innerHTML = `<td class="py-4 px-6 font-medium text-gray-900 dark:text-white ${isDone ? 'line-through opacity-50' : ''}">${task.name}</td><td class="py-4 px-6 text-gray-500 dark:text-pink-200 text-xs uppercase tracking-wide">${task.subjectName}</td><td class="py-4 px-6">${statusHtml}</td><td class="py-4 px-6 text-right flex justify-end gap-2 items-center no-print"><button onclick="toggleTaskStatus('${task.id}')" class="${btnClass} px-3 py-1 rounded-full text-xs font-bold transition-all shadow-sm">${btnText}</button><button onclick="removeTask('${task.id}')" class="text-gray-400 hover:text-red-500 transition-colors ml-2"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }

        function allowDrop(ev) { ev.preventDefault(); }
        function drag(ev, id) { ev.dataTransfer.setData("text/plain", id); }
        function drop(ev, status) { ev.preventDefault(); const id = ev.dataTransfer.getData("text"); moveStatus(id, status); }

        function saveAndRender() {
            localStorage.setItem('ufabc_planner_courses', JSON.stringify(userCourses));
            localStorage.setItem('ufabc_planner_tasks', JSON.stringify(userTasks));
            calculateDashboard();
            renderKanban();
            renderSpreadsheet();
            renderTracker();
            renderTasks();
        }
        
        function downloadData() { const data = { courses: userCourses, tasks: userTasks, customColor: savedHexColor, exportDate: new Date().toISOString() }; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", "meu_planejamento_ufabc.json"); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        function printPDF() { window.print(); }
        function uploadData(inputElement) { const file = inputElement.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.courses && Array.isArray(data.courses)) { userCourses = data.courses; userTasks = data.tasks || []; if(data.customColor) applyCustomTheme(data.customColor); else if(data.theme && data.theme !== 'pink') applyCustomTheme('#3b82f6'); saveAndRender(); alert("Dados carregados com sucesso! ‚ú®"); } else { alert("Arquivo inv√°lido."); } } catch (error) { alert("Erro ao ler arquivo."); } }; reader.readAsText(file); inputElement.value = ''; }
        function clearData() { if (confirm("Tem certeza que deseja apagar TUDO?")) { userCourses = []; userTasks = []; saveAndRender(); } }

        document.addEventListener('DOMContentLoaded', () => {
            applyCustomTheme(savedHexColor);
            document.getElementById('custom-color-input').value = savedHexColor;
            saveAndRender();
        });

    </script>
</body>
</html>